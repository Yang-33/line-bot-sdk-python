name: Diff check and open pull request

on:
  push:
    branches:
      - 'master'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Setup
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Generate codes
        run: python generate-code.py
      - name: Install bump
        run: pip install bump
      - name: Mark if diff exists
        run: |
          diff=$(git --no-pager diff --name-only)
          echo "DIFF_IS_EMPTY=$([[ -z "$diff" ]] && echo 'true' || echo 'false')" >> $GITHUB_ENV
          echo "CURRENT_DATETIME=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      ## TODO: Enable merge change into master directly
      - name: Open pull request if generated code is not same as current one
        if: ${{ env.DIFF_IS_EMPTY != 'true' }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -b update-diff-${{ env.CURRENT_DATETIME }}
          git add .
          git commit -m "Codes are generated by openapi-generator"
          
          VERSION=$(bump -m -r linebot/__about__.py)
          python generate-code.py
          git add .
          git commit -m "Bump version to $VERSION"
          
          pushd line-openapi
          latest_commit_msg=$(git log -1 --pretty=format:%B)
          latest_commit_title=$(echo "$latest_commit_msg" | head -n 1 | sed -r 's/\s*\(\#[0-9]+\)//')
          latest_commit_msg_without_title=$(git log -1 --pretty=format:%b)
          popd

          git push origin update-diff-${{ env.CURRENT_DATETIME }}
          gh pr create -B ${{ github.ref_name }} -t "$latest_commit_title" -b "latest_commit_msg_without_title" --label "auto-generated-code"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
